{% extends "people/base.html" %}
{% load i18n generic_fields friendly_data_formatting generic_tag_tags %}
{% block title %}People - {{person.full_name}}{% endblock %}
{% block css %}{{block.super}}
{% generic_field_css %}
{% compress css %}
<link rel="stylesheet" href="{{STATIC_URL}}css/people_volunteer.css" type="text/css" media="screen, projection"/>
<link rel="stylesheet" href="{{STATIC_URL}}css/people_donor.css" type="text/css" media="screen, projection"/>
<link rel="stylesheet" href="{{STATIC_URL}}css/people_conversations.css" type="text/css" media="screen, projection"/>
<link rel="stylesheet" href="{{STATIC_URL}}css/people_tags.css" type="text/css" media="screen, projection"/>
{% endcompress %}
{% endblock %}
{% block javascript %}{{block.super}}
{% compress js %}
{# TODO #}
<script src="{{STATIC_URL}}js/mycelium/generic_ajax_form.js"></script>
<script src="{{STATIC_URL}}js/contrib/jquery.formset.min.js"></script>

<script src="{{STATIC_URL}}js/mycelium/people_volunteer.js"></script>
<script src="{{STATIC_URL}}js/mycelium/people_donations.js"></script>
<script src="{{STATIC_URL}}js/mycelium/people_conversations.js"></script>
<script src="{{STATIC_URL}}js/mycelium/people_tags.js"></script>
<script src="{{STATIC_URL}}js/mycelium/people_common.js"></script>
<script src="{{STATIC_URL}}js/mycelium/people_person.js"></script>
<script src="{{STATIC_URL}}js/mycelium/conversation_and_gist.js"></script>
{% endcompress %}
{% generic_tags_js %}
{% if request.GET.edit == "ON" or form.instance.full_name == "Unnamed Person"  %}
<script type="text/javascript" charset="utf-8">
$(function(){
    $("#basic_info_form").genericFieldForm('toggle_edit');
	$("#id_first_name").focus();
});
</script>
{% endif %}
<script>
	var person_form_options = {
		"form_objects": {
			"person": {
				save_object_url: "{% url people:person_save %}",
				new_object_url: "{% url people:person_new %}",
				delete_object_url: "{% url people:person_delete %}"
			},
			"phone_number": {
				django_formset_prefix: "{{phone_formset.prefix}}",
				save_object_url: "{% url people:phone_number_save %}",
				new_object_url: "{% url people:phone_number_new %}",
				delete_object_url: "{% url people:phone_number_delete %}"
			},
			"email": {
				django_formset_prefix: "{{email_formset.prefix}}",
				save_object_url: "{% url people:email_save %}",
				new_object_url: "{% url people:email_new %}",
				delete_object_url: "{% url people:email_delete %}"
			},
			"employee": {
				django_formset_prefix: "{{employee_formset.prefix}}",
				save_object_url: "{% url people:employee_save %}",
				new_object_url: "{% url people:employee_new %}",
				delete_object_url: "{% url people:employee_delete %}"
			}
		}
	}
	// person_form_options = $.extend(true, person_form_options, url_options);
	

	var person_data = {};
	person_data["person"] = {
		"initial_data" : {
			"first_name": "{{person.first_name}}",
			"last_name": "{{person.last_name}}",
			"birth_month": "{{person.birth_month}}",
			"birth_day": "{{person.birth_day}}",
			"birth_year": "{{person.birth_year}}",
			"line_1": "{{person.line_1}}",
			"line_2": "{{person.line_2}}",
			"city": "{{person.city}}",
			"state": "{{person.state}}",
			"postal_code": "{{person.postal_code}}",
		},
		"form_fields": {
			"first_name": "{{form.first_name|addslashes|strip_newlines}}",
			"last_name": "{{form.last_name|addslashes|strip_newlines}}",
			"birth_month": "{{form.birth_month|addslashes|strip_newlines}}",
			"birth_day": "{{form.birth_day|addslashes|strip_newlines}}",
			"birth_year": "{{form.birth_year|addslashes|strip_newlines}}",
			"line_1": "{{form.line_1|addslashes|strip_newlines}}",
			"line_2": "{{form.line_2|addslashes|strip_newlines}}",
			"city": "{{form.city|addslashes|strip_newlines}}",
			"state": "{{form.state|addslashes|strip_newlines}}",
			"postal_code": "{{form.postal_code|addslashes|strip_newlines}}",
		}
	}
	person_data["phone"] = [];
	{% for p_form in phone_formset.forms %} 
		person_data["phone"].push(
		{
			"initial_data": {
				"contact_type": "{{p_form.instance.contact_type}}",
				"phone_number": "{{p_form.instance.phone_number}}",
				"primary": {{p_form.instance.primary|lower}},
				"pk": {{p_form.instance.pk}},
			},
			"form_fields": {
				"contact_type": "{{p_form.contact_type|addslashes|strip_newlines}}",
				"phone_number": "{{p_form.phone_number|addslashes|strip_newlines}}",
				"primary": "{{p_form.primary|lower|addslashes|strip_newlines}}",	
				"pk": {{p_form.instance.pk}},
			}
			
		});
	{% endfor %}
	person_data["email"] = [];
	{% for e_form in email_formset.forms %} 
		person_data["email"].push(
		{
			"initial_data": {
				"contact_type": "{{e_form.instance.contact_type}}",
				"email": "{{e_form.instance.email}}",
				"primary": {{e_form.instance.primary|lower}},
				"pk": {{e_form.instance.pk}},
			},
			"form_fields": {
				"contact_type": "{{e_form.contact_type|addslashes|strip_newlines}}",
				"email": "{{e_form.email|addslashes|strip_newlines}}",
				"primary": "{{e_form.primary|lower|addslashes|strip_newlines}}",	
				"pk": {{e_form.instance.pk}},
			}
		});
	{% endfor %}
	// personPage.state.data = person_data;
	// personPage.init();
	$("#basic_info_form").genericAjaxForm(person_form_options);


</script>

{% endblock %}
{% block breadcrumb_links %}<a href="{% url people:search %}" >Back to All People</a>{% endblock %}
{% block page_content %}
<form action="{% url people:person_save_basic person.pk %}" class="edit_mode_off" id="basic_info_form" method="POST">{% csrf_token %}
{% include "people/_save_status_and_button.html" %}



<div itemscope itemtype="http://schema.org/Person" class="basic_info person canonical" form_object_type="person" pk="{{person.pk}}">
	<div class="name_phone_email">
		<div class="name" itemprop="name">
			{% generic_editable_field form.first_name %}
			{% generic_editable_field form.last_name %}
		</div>
	</div>
		<tabbed_box class="open contact_info" name="home">
			<tab_title_container>
			<tab_title>
				<icon class="home"></icon>
				<text>Contacts</text>
			</tab_title>
			</tab_title_container>
			<box_content>
				<div id="no_home_contact_info_message"></div>
				<div class="phone_email">
				<span id="phone_number_form_container">
				{% for p_form in phone_formset.forms %}
				<span class="phone_number_canonical_container">
				<span class="phone_number canonical" form_object_type="phone_number" pk="{{p_form.instance.pk}}">
					<span class="contact_type">{% generic_editable_field p_form.contact_type %}</span>
					<span class="number" itemprop="telephone">{% generic_editable_field p_form.phone_number %}</span>
					<span class="primary">{% generic_editable_field p_form.primary %}</span>
					<span class="delete"><span class="edit_field"><a href="#" class="delete_phone_number_btn mycelium_btn mycelium_small_btn mycelium_grey mycelium_delete_btn">Delete</a></span></span>
				</span>
				</span>
				{% endfor %}
				</span>
				
				<span id="email_form_container">
				{% for e_form in email_formset.forms %}
				<span class="email_canonical_container">
				<span class="email canonical" form_object_type="email" pk="{{e_form.instance.pk}}">
					<span class="contact_type">{% generic_editable_field e_form.contact_type %}</span>
					<span class="number" itemprop="email">{% generic_editable_field e_form.email %}</span>
					<span class="primary">{% generic_editable_field e_form.primary %}</span>
					<span class="delete"><span class="edit_field"><a href="#" class="delete_email_btn mycelium_btn mycelium_small_btn mycelium_grey mycelium_delete_btn">Delete</a></span></span>
				</span>
				</span>
				{% endfor %}
				</span>

				</div>
			<div class="address">
				<span itemprop="streetAddress">
				{% generic_editable_field form.line_1 %}
				{% generic_editable_field form.line_2 %}
				</span>

				<div class="city_state_zip">
					<span itemprop="addressLocality">{% generic_editable_field form.city %}</span><span class="city_state_comma">,</span>
					<span itemprop="addressRegion">{% generic_editable_field form.state %}</span>
					<span itemprop="postalCode">{% generic_editable_field form.postal_code %}</span>
				</div>

			</div>
			<div class="birthday" {% if not person.normalized_birthday %}style="display:none;"{% endif %}>
				<label ><span class="text">Birthday</span></label>
				<span itemprop="birthDate">{% generic_editable_field form.birth_month %}
				{% generic_editable_field form.birth_day %}<span class="date_year_comma">,</span> 
				{% generic_editable_field form.birth_year %}</span>
				<div class="invalid_date">Hm. <span class="selected_month"></span> <span class="selected_day"></span> isn't a real date, and can't be saved.</div>
			</div>
		</box_content>
		</tabbed_box>
		{% for e_form in employee_formset.forms %}
		<span class="employee canonical" form_object_type="employee" pk="{{e_form.instance.pk}}">
		<tabbed_box class="open" name="job">
			<tab_title_container>
			<a href="{% url organizations:organization e_form.instance.organization.pk %}">
			<tab_title>
				<icon class="company"></icon>
				<text>{{e_form.instance.organization}}</text>
			</tab_title>
			</a>
			</tab_title_container>
			<box_content>
				{% generic_editable_field e_form.role %}
				{% generic_editable_field e_form.phone_number %}
				{% generic_editable_field_email e_form.email %}
				{% for f in e_form.hidden_fields %}{{f}}{% endfor %}
			</box_content>
		</tabbed_box>
		</span>
		{% endfor %}
		{{employee_formset.management_form}}


</div>

</form>



<detail_tabs update_url="{% url people:tab_contents person.pk %}">
	{# <a class="detail_tab current" href="#recent_activity">Recent Activity</a> #}
	<a class="detail_tab current" href="#conversations">Conversations</a>	
	<a class="detail_tab" href="#volunteer">Volunteer</a>
	<a class="detail_tab" href="#donor">Donations</a>
	<a class="detail_tab" href="#tags">Tags</a>
</detail_tabs>
<detail_tab_contents>
	<fragment name="detail_tab" action="replace" class="detail_tab">
		{# {% include "recent_activity/_people_recent_activity_tab.html" %} #}
		{% include "conversations/_people_conversations_tab.html" %}
	</fragment>
</detail_tab_contents>
{% if request.useraccount.is_admin %}
<delete_object_block>
	<form action="{% url people:delete_person %}" method="POST" id="delete_person_form">{% csrf_token %}
	<input type="hidden" name="person_pk" value="{{form.instance.pk}}">
	<a href="#" class="mycelium_btn mycelium_active_grey mycelium_delete_btn person_delete_btn" >Delete this Person</a>
	</form>
</delete_object_block>
{% endif %}
{% endblock %}